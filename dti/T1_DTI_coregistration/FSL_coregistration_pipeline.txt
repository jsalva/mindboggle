# FSL COREGISTRATION PIPELINE

# 1) Erode FA image to get rid of bright edge.
fslmaths 50235_FA.nii.gz -kernel 3D -ero FA_eroded

# 2) Crop T1-file to reduce FOV to where there is brain. (Save a lot of computational time)
fslroi T1data_masked.nii.gz T1_cropped 64 126 45 173 20 134

# Register FA image to T1 image. Intuitively this would make sense
# since we want to be in undistorted space, i.e. in T1 space.
# Note that the associated .cnf file
# a. Considers zero as "missing value" in both --ref and --in
# b. Ends with subsampling 2 since the ~1mm res in the T1 is overkill

# 3) Start with finding an affine transform
flirt -ref T1_cropped.nii.gz -in FA_eroded.nii.gz -omat FA_2_T1_Affine -out flirt_checking

# 4) And non-linear
fnirt --config=../FA_2_same_subject_T1.cnf --aff=FA_2_T1_Affine --ref=T1_cropped.nii.gz --in=FA_eroded.nii.gz --cout=FA_2_T1_warpcoef --iout=FA_warped_2_T1


# 5) Moving the DTI_first_volume to T1 cropped space
applywarp --ref=T1_cropped.nii.gz --in=DTI_firstVolume.nii.gz --warp=FA_2_T1_warpcoef.nii.gz --out=DTI_warped_2_T1

# 6) Computing the inverse warp
invwarp --ref=FA_eroded.nii.gz --warp=FA_2_T1_warpcoef.nii.gz --out=T1_2_FA_warpcoef.nii.gz

# 7) Moving ROIs to DTI space using the Nearest Neighbor interpolation
# 7a) Cropping of the ROI
fslroi mri___aparc+aseg_T1.nii.gz roi_T1_cropped.nii.gz 64 126 45 173 20 134
# 7b) Moving the ROI
applywarp --ref=FA_eroded.nii.gz --in=roi_T1_cropped.nii.gz --warp=T1_2_FA_warpcoef.nii.gz --out=roi_warped_2_FA.nii.gz --interp=nn